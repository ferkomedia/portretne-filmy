---
import BaseLayout from "../../layouts/BaseLayout.astro";
---

<BaseLayout title="Admin | Spr√°va" noindex={true}>
  <div class="container">

    <section class="heroSection">
      <div class="heroContent">
        <h1>Spr√°va FerkoMedia</h1>
        <p class="heroLead">Fakt√∫ry, workshopy, email marketing</p>
      </div>
    </section>

    <!-- TABS -->
    <section class="section">
      <div class="adminTabs">
        <button class="adminTab active" data-tab="invoices">Fakt√∫ry</button>
        <button class="adminTab" data-tab="workshops">Workshopy</button>
        <button class="adminTab" data-tab="email">Email Marketing</button>
      </div>

      <!-- FAKT√öRY TAB -->
      <div class="tabContent active" id="tab-invoices">
      <div class="statsGrid">
        <div class="statCard">
          <span class="statValue" id="statTotal">-</span>
          <span class="statLabel">Fakt√∫r celkom</span>
        </div>
        <div class="statCard">
          <span class="statValue" id="statRevenue">-</span>
          <span class="statLabel">Celkov√Ω pr√≠jem</span>
        </div>
        <div class="statCard">
          <span class="statValue" id="statMonthCount">-</span>
          <span class="statLabel">Tento mesiac</span>
        </div>
        <div class="statCard">
          <span class="statValue" id="statMonthRevenue">-</span>
          <span class="statLabel">Pr√≠jem tento mesiac</span>
        </div>
      </div>

      <div class="invoiceControls">
        <input type="text" id="searchInvoice" placeholder="Hƒæada≈• podƒæa mena, emailu, IƒåO..." class="searchInput" />
        <button class="btn btn--primary" id="loadInvoices">Naƒç√≠ta≈• fakt√∫ry</button>
      </div>

      <div class="tableWrapper">
        <table class="invoiceTable">
          <thead>
            <tr>
              <th>ƒå√≠slo</th>
              <th>D√°tum</th>
              <th>Z√°kazn√≠k</th>
              <th>Firma / IƒåO</th>
              <th>Produkt</th>
              <th>Suma</th>
              <th>Stav</th>
            </tr>
          </thead>
          <tbody id="invoiceTableBody">
            <tr>
              <td colspan="7" class="emptyState">Klikni na "Naƒç√≠ta≈• fakt√∫ry" pre zobrazenie</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="loadMoreWrapper" style="display:none; text-align:center; margin-top:1rem;">
        <button class="btn btn--ghost" id="loadMore">Naƒç√≠ta≈• ƒèal≈°ie</button>
      </div>
    </div>

    <!-- WORKSHOPY TAB -->
    <div class="tabContent" id="tab-workshops">
      <h2>Prida≈• nov√Ω term√≠n</h2>
      <div class="formCard">
        <form id="addTermForm">
          <div class="formGrid">
            <div class="field">
              <label for="title">Typ workshopu</label>
              <select id="title" required>
                <option value="">Vyber typ</option>
                <option value="Web za 1 de≈à">Web za 1 de≈à</option>
                <option value="E-shop za 1 de≈à">E-shop za 1 de≈à</option>
                <option value="Google reklama za 1 de≈à">Google reklama za 1 de≈à</option>
                <option value="Soci√°lne siete za 1 de≈à">Soci√°lne siete za 1 de≈à</option>
                <option value="AI n√°stroje za 1 de≈à">AI n√°stroje za 1 de≈à</option>
              </select>
            </div>

            <div class="field">
              <label for="date">D√°tum</label>
              <input id="date" type="text" placeholder="DD.MM.RRRR" required />
            </div>

            <div class="field">
              <label for="city">Mesto</label>
              <input id="city" type="text" value="Martin" required />
            </div>

            <div class="field">
              <label for="price">Cena (‚Ç¨)</label>
              <input id="price" type="number" value="149" required />
            </div>

            <div class="field">
              <label for="capacity">Kapacita</label>
              <input id="capacity" type="number" value="12" required />
            </div>

            <div class="field">
              <label for="status">Status</label>
              <select id="status">
                <option value="open">Otvoren√Ω</option>
                <option value="closed">Zatvoren√Ω</option>
              </select>
            </div>
          </div>

          <div class="formActions">
            <button type="submit" class="btn btn--primary">Generova≈• JSON</button>
          </div>
        </form>

        <div id="jsonOutput" style="display:none; margin-top:1.5rem;">
          <h3>Nov√Ω JSON z√°znam:</h3>
          <pre id="jsonCode"></pre>
          <p class="help">Skop√≠ruj tento z√°znam a pridaj ho do s√∫boru src/data/workshop-terms.json</p>
        </div>
      </div>

      <h2 style="margin-top:3rem;">Ako upravi≈• term√≠ny</h2>
      <div class="stepsGrid">
        <div class="stepCard">
          <span class="stepNum">1</span>
          <h4>Otvor s√∫bor</h4>
          <p>src/data/workshop-terms.json</p>
        </div>
        <div class="stepCard">
          <span class="stepNum">2</span>
          <h4>Uprav JSON</h4>
          <p>Pridaj, zme≈à alebo odstr√°≈à term√≠ny.</p>
        </div>
        <div class="stepCard">
          <span class="stepNum">3</span>
          <h4>Commit a Push</h4>
          <p>git add . && git commit && git push</p>
        </div>
        <div class="stepCard">
          <span class="stepNum">4</span>
          <h4>Hotovo</h4>
          <p>Cloudflare automaticky deployuje.</p>
        </div>
      </div>
    </div>

    <!-- EMAIL MARKETING TAB -->
    <div class="tabContent" id="tab-email">
      <!-- Stats -->
      <div class="statsGrid">
        <div class="statCard">
          <span class="statValue" id="emailStatTotal">-</span>
          <span class="statLabel">Kontaktov celkom</span>
        </div>
        <div class="statCard">
          <span class="statValue" id="emailStatWorkshops">-</span>
          <span class="statLabel">Z workshopov</span>
        </div>
        <div class="statCard">
          <span class="statValue" id="emailStatContact">-</span>
          <span class="statLabel">Z kontaktu</span>
        </div>
        <div class="statCard">
          <span class="statValue" id="emailStatCampaigns">-</span>
          <span class="statLabel">Odoslan√Ωch kampan√≠</span>
        </div>
      </div>

      <!-- Sub-tabs -->
      <div class="subTabs">
        <button class="subTab active" data-subtab="contacts">Kontakty</button>
        <button class="subTab" data-subtab="campaigns">Kampane</button>
        <button class="subTab" data-subtab="templates">≈†abl√≥ny</button>
        <button class="subTab" data-subtab="tags">Tagy</button>
        <button class="subTab" data-subtab="automation">Automatiz√°cia</button>
      </div>

      <!-- CONTACTS SUBTAB -->
      <div class="subTabContent active" id="subtab-contacts">
        <div class="emailControls">
          <input type="text" id="searchContacts" placeholder="Hƒæada≈• kontakty..." class="searchInput" />
          <select id="filterSource" class="filterSelect">
            <option value="">V≈°etky zdroje</option>
            <option value="workshop">Workshop</option>
            <option value="kontakt">Kontakt</option>
            <option value="dlhodoba-spolupraca">Dlhodob√° spolupr√°ca</option>
          </select>
          <select id="filterTag" class="filterSelect">
            <option value="">V≈°etky tagy</option>
            <option value="VIP">VIP</option>
            <option value="Z√°ujemca">Z√°ujemca</option>
            <option value="K√∫pil">K√∫pil</option>
          </select>
          <button class="btn btn--primary" id="loadContacts">Naƒç√≠ta≈• kontakty</button>
          <button class="btn btn--ghost" id="exportContacts">Export CSV</button>
          <button class="btn btn--ghost" id="importContactsBtn">üì• Import CSV</button>
        </div>

        <div class="tableWrapper">
          <table class="invoiceTable">
            <thead>
              <tr>
                <th><input type="checkbox" id="selectAll" /></th>
                <th>Meno</th>
                <th>Email</th>
                <th>Zdroj</th>
                <th>Tagy</th>
                <th>D√°tum</th>
                <th>Akcie</th>
              </tr>
            </thead>
            <tbody id="contactsTableBody">
              <tr>
                <td colspan="7" class="emptyState">Klikni na "Naƒç√≠ta≈• kontakty"</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div id="selectedActions" style="display:none; margin-top:1rem; padding:1rem; background:rgba(249,115,22,0.1); border-radius:8px;">
          <span id="selectedCount">0</span> oznaƒçen√Ωch kontaktov
          <button class="btn btn--primary btn--small" id="sendToSelected" style="margin-left:1rem;">Odosla≈• kampa≈à</button>
          <button class="btn btn--ghost btn--small" id="addTagToSelected">Prida≈• tag</button>
          <button class="btn btn--ghost btn--small" id="deleteSelected">Vymaza≈•</button>
        </div>
      </div>

      <!-- CAMPAIGNS SUBTAB -->
      <div class="subTabContent" id="subtab-campaigns">
        <button class="btn btn--primary" id="createCampaignBtn" style="margin-bottom:2rem;">+ Vytvori≈• nov√∫ kampa≈à</button>

        <div id="campaignForm" style="display:none;" class="formCard">
          <h3>Nov√° kampa≈à</h3>
          <form id="newCampaignForm">
            <div class="formGrid">
              <div class="field fieldFull">
                <label for="campaignName">N√°zov kampane</label>
                <input id="campaignName" type="text" placeholder="Napr. Zimn√° ponuka 2026" required />
              </div>

              <div class="field fieldFull">
                <label for="campaignSubject">Predmet emailu (m√¥≈æe≈° pou≈æi≈• <code>&#123;meno&#125;</code>, <code>&#123;email&#125;</code>)</label>
                <input id="campaignSubject" type="text" placeholder="Ahoj {meno}, m√°me pre teba novinky!" required />
              </div>

              <div class="field fieldFull">
                <label for="campaignTemplate">≈†abl√≥na</label>
                <select id="campaignTemplate" required>
                  <option value="">Vyber ≈°abl√≥nu</option>
                  <option value="newsletter">Newsletter</option>
                  <option value="workshop-promo">Workshop propag√°cia</option>
                  <option value="custom">Vlastn√Ω text</option>
                </select>
              </div>

              <div class="field fieldFull" id="customContentField" style="display:none;">
                <label for="campaignContent">Obsah emailu (HTML) - m√¥≈æe≈° pou≈æi≈• <code>&#123;meno&#125;</code>, <code>&#123;email&#125;</code></label>
                <textarea id="campaignContent" rows="10" placeholder="<h1>Ahoj &#123;meno&#125;!</h1><p>Text...</p>"></textarea>
              </div>

              <div class="field fieldFull">
                <label for="campaignSegment">Komu odosla≈•?</label>
                <select id="campaignSegment">
                  <option value="all">V≈°etk√Ωm kontaktom</option>
                  <option value="workshop">Len workshopom</option>
                  <option value="kontakt">Len kontaktu</option>
                  <option value="selected">Oznaƒçen√Ωm kontaktom</option>
                  <option value="tag">Podƒæa tagu</option>
                </select>
              </div>

              <div class="field fieldFull" id="tagSegmentField" style="display:none;">
                <label for="campaignTag">Vyber tag</label>
                <select id="campaignTag">
                  <option value="VIP">VIP</option>
                  <option value="Z√°ujemca">Z√°ujemca</option>
                  <option value="K√∫pil">K√∫pil</option>
                </select>
              </div>

              <div class="field fieldFull">
                <label for="campaignSchedule">Odoslanie</label>
                <select id="campaignSchedule">
                  <option value="now">Odosla≈• hneƒè</option>
                  <option value="scheduled">Napl√°nova≈• na nesk√¥r</option>
                </select>
              </div>

              <div class="field fieldFull" id="scheduleTimeField" style="display:none;">
                <label for="campaignDateTime">D√°tum a ƒças odoslania</label>
                <input id="campaignDateTime" type="datetime-local" />
              </div>
            </div>

            <div class="formActions">
              <button type="button" class="btn btn--ghost" id="previewEmailBtn">üëÅÔ∏è N√°hƒæad</button>
              <button type="button" class="btn btn--ghost" id="sendTestEmailBtn">üìß Test email</button>
              <button type="submit" class="btn btn--primary">Vytvori≈• a odosla≈•</button>
              <button type="button" class="btn btn--ghost" id="cancelCampaign">Zru≈°i≈•</button>
            </div>
          </form>
        </div>

        <!-- Personalization Help Box -->
        <div class="personalizationHelp" style="margin-bottom:2rem; padding:1rem; background:rgba(249,115,22,0.1); border-radius:8px; border-left:4px solid #f97316;">
          <h4 style="margin:0 0 0.5rem 0; color:#f97316;">üí° Personaliz√°cia emailov</h4>
          <p style="margin:0; font-size:0.875rem; color:rgba(255,255,255,0.7);">
            Pou≈æi tieto premenn√© v predmete alebo texte emailu:
            <code style="background:rgba(0,0,0,0.3); padding:0.15rem 0.4rem; border-radius:4px; margin:0 0.25rem;">&#123;meno&#125;</code> - meno kontaktu,
            <code style="background:rgba(0,0,0,0.3); padding:0.15rem 0.4rem; border-radius:4px; margin:0 0.25rem;">&#123;email&#125;</code> - email kontaktu
          </p>
        </div>

        <h3 style="margin-top:2rem;">Hist√≥ria kampan√≠</h3>
        <div class="tableWrapper">
          <table class="invoiceTable">
            <thead>
              <tr>
                <th>N√°zov</th>
                <th>Predmet</th>
                <th>Odoslan√Ωch</th>
                <th>Open Rate</th>
                <th>Click Rate</th>
                <th>D√°tum</th>
                <th>Akcie</th>
              </tr>
            </thead>
            <tbody id="campaignsTableBody">
              <tr>
                <td colspan="7" class="emptyState">≈Ωiadne kampane</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- TEMPLATES SUBTAB -->
      <div class="subTabContent" id="subtab-templates">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
          <h3>Email ≈°abl√≥ny</h3>
          <button class="btn btn--primary" id="createCustomTemplateBtn">+ Vytvori≈• vlastn√∫ ≈°abl√≥nu</button>
        </div>

        <div class="templatesGrid">
          <div class="templateCard">
            <h4>Newsletter</h4>
            <p>Z√°kladn√° ≈°abl√≥na pre newsletter s novinkami a ponukami.</p>
            <div style="display:flex; gap:0.5rem;">
              <button class="btn btn--ghost btn--small" onclick="previewTemplate('newsletter')">N√°hƒæad</button>
              <button class="btn btn--ghost btn--small" onclick="useTemplate('newsletter')">Pou≈æi≈•</button>
            </div>
          </div>
          <div class="templateCard">
            <h4>Workshop propag√°cia</h4>
            <p>≈†abl√≥na na propag√°ciu nadch√°dzaj√∫cich workshopov.</p>
            <div style="display:flex; gap:0.5rem;">
              <button class="btn btn--ghost btn--small" onclick="previewTemplate('workshop-promo')">N√°hƒæad</button>
              <button class="btn btn--ghost btn--small" onclick="useTemplate('workshop-promo')">Pou≈æi≈•</button>
            </div>
          </div>
          <div class="templateCard">
            <h4>Vlastn√Ω</h4>
            <p>Vytvor si vlastn√Ω email s HTML k√≥dom.</p>
            <div style="display:flex; gap:0.5rem;">
              <button class="btn btn--ghost btn--small" onclick="selectCustomTemplate()">Pou≈æi≈•</button>
            </div>
          </div>
          <div id="customTemplatesContainer"></div>
        </div>
      </div>

      <!-- TAGS SUBTAB -->
      <div class="subTabContent" id="subtab-tags">
        <h3>Spr√°va tagov</h3>
        <div class="formCard">
          <form id="createTagForm">
            <div class="formGrid">
              <div class="field">
                <label for="tagName">N√°zov tagu</label>
                <input id="tagName" type="text" placeholder="Napr. VIP, Z√°ujemca" required />
              </div>
              <div class="field">
                <label for="tagColor">Farba</label>
                <select id="tagColor">
                  <option value="blue">Modr√°</option>
                  <option value="green">Zelen√°</option>
                  <option value="orange">Oran≈æov√°</option>
                  <option value="purple">Fialov√°</option>
                  <option value="red">ƒåerven√°</option>
                </select>
              </div>
            </div>
            <div class="formActions">
              <button type="submit" class="btn btn--primary">Vytvori≈• tag</button>
            </div>
          </form>
        </div>

        <h4 style="margin-top:2rem;">Existuj√∫ce tagy</h4>
        <div class="tagsGrid" id="existingTags">
          <div class="tagItem">
            <span class="tagBadge tagBadge--blue">VIP</span>
            <span class="tagCount">12 kontaktov</span>
            <button class="btn btn--ghost btn--small" onclick="deleteTag('VIP')">Vymaza≈•</button>
          </div>
          <div class="tagItem">
            <span class="tagBadge tagBadge--green">Z√°ujemca</span>
            <span class="tagCount">34 kontaktov</span>
            <button class="btn btn--ghost btn--small" onclick="deleteTag('Z√°ujemca')">Vymaza≈•</button>
          </div>
          <div class="tagItem">
            <span class="tagBadge tagBadge--orange">K√∫pil</span>
            <span class="tagCount">89 kontaktov</span>
            <button class="btn btn--ghost btn--small" onclick="deleteTag('K√∫pil')">Vymaza≈•</button>
          </div>
        </div>
      </div>

      <!-- AUTOMATION SUBTAB -->
      <div class="subTabContent" id="subtab-automation">
        <h3>Automatick√© kampane</h3>
        <button class="btn btn--primary" id="createAutomationBtn" style="margin-bottom:2rem;">+ Vytvori≈• automatiz√°ciu</button>

        <div class="automationCards">
          <div class="automationCard">
            <div class="automationHeader">
              <h4>Welcome email</h4>
              <label class="toggle">
                <input type="checkbox" checked />
                <span class="slider"></span>
              </label>
            </div>
            <p>Automaticky odo≈°le welcome email nov√Ωm kontaktom</p>
            <div class="automationStats">
              <span>Trigger: Nov√Ω kontakt</span>
              <span>Odoslan√Ωch: 156</span>
            </div>
            <button class="btn btn--ghost btn--small" onclick="editAutomation('welcome')">Upravi≈•</button>
          </div>

          <div class="automationCard">
            <div class="automationHeader">
              <h4>Workshop follow-up</h4>
              <label class="toggle">
                <input type="checkbox" checked />
                <span class="slider"></span>
              </label>
            </div>
            <p>Odo≈°le email 3 dni po workshope</p>
            <div class="automationStats">
              <span>Trigger: Po workshope (+3 dni)</span>
              <span>Odoslan√Ωch: 89</span>
            </div>
            <button class="btn btn--ghost btn--small" onclick="editAutomation('followup')">Upravi≈•</button>
          </div>

          <div class="automationCard">
            <div class="automationHeader">
              <h4>Re-engagement</h4>
              <label class="toggle">
                <input type="checkbox" />
                <span class="slider"></span>
              </label>
            </div>
            <p>Aktivuje kontakty po 30 d≈àoch neƒçinnosti</p>
            <div class="automationStats">
              <span>Trigger: 30 dn√≠ bez aktivity</span>
              <span>Odoslan√Ωch: 23</span>
            </div>
            <button class="btn btn--ghost btn--small" onclick="editAutomation('reengagement')">Upravi≈•</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- MODALS -->
  <!-- Import CSV Modal -->
  <div id="importModal" class="modal" style="display:none;">
    <div class="modalContent">
      <div class="modalHeader">
        <h3>Import kontaktov z CSV</h3>
        <button class="modalClose" onclick="closeModal('importModal')">&times;</button>
      </div>
      <div class="modalBody">
        <p class="help">CSV s√∫bor mus√≠ obsahova≈• stƒ∫pce: <strong>meno</strong>, <strong>email</strong>, <strong>zdroj</strong> (voliteƒæn√©)</p>
        <p class="help" style="margin-bottom:1rem;">Prv√Ω riadok = hlaviƒçka. Oddeƒæovaƒç: ƒçiarka alebo bodkoƒçiarka.</p>

        <div class="fileDropZone" id="fileDropZone">
          <input type="file" id="csvFileInput" accept=".csv,.txt" style="display:none;" />
          <div class="dropZoneContent">
            <span style="font-size:2rem;">üìÅ</span>
            <p>Pretiahni CSV s√∫bor sem<br>alebo <strong style="color:#f97316; cursor:pointer;" onclick="document.getElementById('csvFileInput').click()">vyber s√∫bor</strong></p>
          </div>
        </div>

        <div id="csvPreview" style="display:none; margin-top:1.5rem;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
            <h4 style="margin:0;">N√°hƒæad (prv√Ωch 5 riadkov):</h4>
            <span id="csvRowCount" class="badge badge--success"></span>
          </div>
          <div class="tableWrapper">
            <table class="invoiceTable" id="csvPreviewTable">
              <thead id="csvPreviewHead"></thead>
              <tbody id="csvPreviewBody"></tbody>
            </table>
          </div>
          <div id="csvErrors" style="margin-top:1rem;"></div>
        </div>
      </div>
      <div class="modalFooter">
        <button class="btn btn--ghost" onclick="closeModal('importModal')">Zru≈°i≈•</button>
        <button class="btn btn--primary" id="confirmImportBtn" disabled>Importova≈•</button>
      </div>
    </div>
  </div>

  <!-- Email Preview Modal -->
  <div id="previewModal" class="modal" style="display:none;">
    <div class="modalContent modalLarge">
      <div class="modalHeader">
        <h3>N√°hƒæad emailu</h3>
        <div style="display:flex; gap:0.5rem;">
          <button class="btn btn--small previewToggle active" data-view="desktop">Desktop</button>
          <button class="btn btn--small previewToggle" data-view="mobile">Mobile</button>
        </div>
        <button class="modalClose" onclick="closeModal('previewModal')">&times;</button>
      </div>
      <div class="modalBody">
        <div class="emailPreview" id="emailPreviewContent">
          <div class="emailPreviewHeader">
            <strong>Od:</strong> FerkoMedia &lt;noreply@portretnefilmy.sk&gt;<br>
            <strong>Komu:</strong> <span id="previewTo">jan.novak@email.sk</span><br>
            <strong>Predmet:</strong> <span id="previewSubject"></span>
          </div>
          <div class="emailPreviewBody" id="previewBody"></div>
        </div>
      </div>
      <div class="modalFooter">
        <button class="btn btn--ghost" onclick="closeModal('previewModal')">Zavrie≈•</button>
        <button class="btn btn--primary" id="sendTestFromPreview">üìß Odosla≈• test na m√¥j email</button>
      </div>
    </div>
  </div>

  <!-- Test Email Modal -->
  <div id="testEmailModal" class="modal" style="display:none;">
    <div class="modalContent">
      <div class="modalHeader">
        <h3>Odosla≈• testovac√≠ email</h3>
        <button class="modalClose" onclick="closeModal('testEmailModal')">&times;</button>
      </div>
      <div class="modalBody">
        <div class="field">
          <label for="testEmailAddress">Email adresa pre test</label>
          <input id="testEmailAddress" type="email" placeholder="tvoj@email.sk" required />
        </div>
        <p class="help" style="margin-top:1rem;">
          üìå Email bude odoslan√Ω s uk√°≈ækov√Ωmi d√°tami:<br>
          <code>&#123;meno&#125;</code> ‚Üí "J√°n Nov√°k"<br>
          <code>&#123;email&#125;</code> ‚Üí tvoja zadan√° adresa
        </p>
      </div>
      <div class="modalFooter">
        <button class="btn btn--ghost" onclick="closeModal('testEmailModal')">Zru≈°i≈•</button>
        <button class="btn btn--primary" id="confirmTestEmail">Odosla≈• test</button>
      </div>
    </div>
  </div>

  <!-- Contact Notes Modal -->
  <div id="notesModal" class="modal" style="display:none;">
    <div class="modalContent">
      <div class="modalHeader">
        <h3>Pozn√°mky ku kontaktu</h3>
        <button class="modalClose" onclick="closeModal('notesModal')">&times;</button>
      </div>
      <div class="modalBody">
        <p><strong>Email:</strong> <span id="notesContactEmail"></span></p>
        <textarea id="contactNotes" rows="6" placeholder="Pridaj pozn√°mky..." style="width:100%; padding:0.75rem; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background:rgba(0,0,0,0.3); color:white;"></textarea>
        <div id="notesHistory" style="margin-top:1rem;">
          <h4>Hist√≥ria pozn√°mok:</h4>
          <div class="notesList"></div>
        </div>
      </div>
      <div class="modalFooter">
        <button class="btn btn--ghost" onclick="closeModal('notesModal')">Zru≈°i≈•</button>
        <button class="btn btn--primary" id="saveNotesBtn">Ulo≈æi≈•</button>
      </div>
    </div>
  </div>

  <!-- Add Tag Modal -->
  <div id="addTagModal" class="modal" style="display:none;">
    <div class="modalContent">
      <div class="modalHeader">
        <h3>Prida≈• tag</h3>
        <button class="modalClose" onclick="closeModal('addTagModal')">&times;</button>
      </div>
      <div class="modalBody">
        <select id="selectTagToAdd" style="width:100%; padding:0.75rem; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background:rgba(0,0,0,0.3); color:white;">
          <option value="VIP">VIP</option>
          <option value="Z√°ujemca">Z√°ujemca</option>
          <option value="K√∫pil">K√∫pil</option>
        </select>
      </div>
      <div class="modalFooter">
        <button class="btn btn--ghost" onclick="closeModal('addTagModal')">Zru≈°i≈•</button>
        <button class="btn btn--primary" id="confirmAddTagBtn">Prida≈•</button>
      </div>
    </div>
  </div>

  <!-- Create Automation Modal -->
  <div id="createAutomationModal" class="modal" style="display:none;">
    <div class="modalContent">
      <div class="modalHeader">
        <h3>Vytvori≈• nov√∫ automatiz√°ciu</h3>
        <button class="modalClose" onclick="closeModal('createAutomationModal')">&times;</button>
      </div>
      <div class="modalBody">
        <form id="newAutomationForm">
          <div class="formGrid">
            <div class="field fieldFull">
              <label for="autoName">N√°zov automatiz√°cie</label>
              <input id="autoName" type="text" placeholder="Napr. Onboarding s√©ria" required />
            </div>

            <div class="field fieldFull">
              <label for="autoTrigger">Trigger</label>
              <select id="autoTrigger" required>
                <option value="">Vyber trigger</option>
                <option value="new-contact">Nov√Ω kontakt</option>
                <option value="workshop-complete">Po workshope</option>
                <option value="tag-added">Pri pridan√≠ tagu</option>
                <option value="inactivity">Po X d≈àoch neƒçinnosti</option>
              </select>
            </div>

            <div class="field" id="inactivityDaysField" style="display:none;">
              <label for="autoDays">Poƒçet dn√≠ neƒçinnosti</label>
              <input id="autoDays" type="number" value="30" min="1" />
            </div>

            <div class="field" id="tagTriggerField" style="display:none;">
              <label for="autoTriggerTag">Pri akom tagu?</label>
              <select id="autoTriggerTag">
                <option value="VIP">VIP</option>
                <option value="Z√°ujemca">Z√°ujemca</option>
                <option value="K√∫pil">K√∫pil</option>
              </select>
            </div>

            <div class="field fieldFull">
              <label for="autoEmailSubject">Predmet emailu</label>
              <input id="autoEmailSubject" type="text" placeholder="Ahoj &#123;meno&#125;, vitaj!" required />
            </div>

            <div class="field fieldFull">
              <label for="autoEmailContent">Obsah emailu (HTML)</label>
              <textarea id="autoEmailContent" rows="8" placeholder="<h1>Vitaj!</h1><p>Text...</p>" required></textarea>
            </div>
          </div>

          <div class="formActions">
            <button type="button" class="btn btn--ghost" onclick="closeModal('createAutomationModal')">Zru≈°i≈•</button>
            <button type="submit" class="btn btn--primary">Vytvori≈• automatiz√°ciu</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Automation Modal -->
  <div id="editAutomationModal" class="modal" style="display:none;">
    <div class="modalContent">
      <div class="modalHeader">
        <h3>Upravi≈• automatiz√°ciu</h3>
        <button class="modalClose" onclick="closeModal('editAutomationModal')">&times;</button>
      </div>
      <div class="modalBody">
        <form id="editAutomationForm">
          <input type="hidden" id="editAutoId" />

          <div class="formGrid">
            <div class="field fieldFull">
              <label for="editAutoName">N√°zov</label>
              <input id="editAutoName" type="text" required />
            </div>

            <div class="field fieldFull">
              <label for="editAutoSubject">Predmet emailu</label>
              <input id="editAutoSubject" type="text" required />
            </div>

            <div class="field fieldFull">
              <label for="editAutoContent">Obsah emailu (HTML)</label>
              <textarea id="editAutoContent" rows="10" required></textarea>
            </div>

            <div class="field fieldFull">
              <label>
                <input type="checkbox" id="editAutoActive" />
                Akt√≠vna automatiz√°cia
              </label>
            </div>
          </div>

          <div class="formActions">
            <button type="button" class="btn btn--ghost" onclick="closeModal('editAutomationModal')">Zru≈°i≈•</button>
            <button type="submit" class="btn btn--primary">Ulo≈æi≈• zmeny</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  </div>
</BaseLayout>

<script>
document.addEventListener('DOMContentLoaded', () => {

  const adminPassword = "MyFilmy2026@";

  // =====================
  // EMAIL TEMPLATES
  // =====================
  const emailTemplates = {
    newsletter: {
      subject: 'Novinky od FerkoMedia - {meno}',
      content: `
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
          <h1 style="color: #f97316;">Ahoj {meno}!</h1>
          <p>M√°me pre teba novinky z FerkoMedia.</p>
          <p>Pozri si na≈°e najnov≈°ie projekty a ponuky.</p>
          <a href="https://portretnefilmy.sk" style="display: inline-block; background: #f97316; color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px; margin-top: 20px;">Pozrie≈• viac</a>
          <p style="margin-top: 30px; font-size: 12px; color: #666;">
            Tento email bol odoslan√Ω na {email}.<br>
            <a href="#">Odhl√°si≈• sa</a>
          </p>
        </div>
      `
    },
    'workshop-promo': {
      subject: 'Workshop pre teba, {meno}!',
      content: `
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
          <h1 style="color: #f97316;">üéì Workshop pre teba!</h1>
          <p>Ahoj {meno},</p>
          <p>Pripravili sme nov√Ω workshop, ktor√Ω by ≈•a mohol zauj√≠ma≈•.</p>
          <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <h2 style="margin-top: 0;">Web za 1 de≈à</h2>
            <p>üìÖ D√°tum: 15.2.2026</p>
            <p>üìç Miesto: Martin</p>
            <p>üí∞ Cena: 149‚Ç¨</p>
          </div>
          <a href="https://portretnefilmy.sk/workshopy" style="display: inline-block; background: #f97316; color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px;">Rezervova≈• miesto</a>
          <p style="margin-top: 30px; font-size: 12px; color: #666;">
            Kontakt: {email}
          </p>
        </div>
      `
    },
    custom: {
      subject: '',
      content: ''
    }
  };

  // =====================
  // PERSONALIZATION HELPER
  // =====================
  function personalize(text, data = {}) {
    const defaults = {
      meno: data.meno || 'J√°n Nov√°k',
      email: data.email || 'jan.novak@email.sk'
    };
    return text
      .replace(/\{meno\}/g, defaults.meno)
      .replace(/\{email\}/g, defaults.email);
  }

  // =====================
  // TABS
  // =====================
  document.querySelectorAll('.adminTab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.adminTab, .tabContent')
        .forEach(el => el.classList.remove('active'));

      tab.classList.add('active');
      document.getElementById(`tab-${tab.dataset.tab}`)?.classList.add('active');

      if (tab.dataset.tab === 'email') loadEmailStats();
    });
  });

  document.querySelectorAll('.subTab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.subTab, .subTabContent')
        .forEach(el => el.classList.remove('active'));

      tab.classList.add('active');
      document.getElementById(`subtab-${tab.dataset.subtab}`)?.classList.add('active');
    });
  });

  // =====================
  // WORKSHOP JSON
  // =====================
  document.getElementById('addTermForm')?.addEventListener('submit', e => {
    e.preventDefault();
    const term = {
      title: document.getElementById('title').value,
      date: document.getElementById('date').value,
      city: document.getElementById('city').value,
      price: +document.getElementById('price').value,
      capacity: +document.getElementById('capacity').value,
      status: document.getElementById('status').value
    };
    document.getElementById('jsonCode').textContent = JSON.stringify(term, null, 2);
    document.getElementById('jsonOutput').style.display = 'block';
  });

  // =====================
  // INVOICES
  // =====================
  let offset = 0;
  const limit = 50;
  let allInvoices = [];

  document.getElementById('loadInvoices')?.addEventListener('click', () => loadInvoices(false));
  document.getElementById('loadMore')?.addEventListener('click', () => {
    offset += limit;
    loadInvoices(true);
  });

  document.getElementById('searchInvoice')?.addEventListener('input', e =>
    filterInvoices(e.target.value.toLowerCase())
  );

  async function loadInvoices(append) {
    const key = prompt('Admin kƒæ√∫ƒç:');
    if (!key) return;

    const res = await fetch(`/api/get-invoices?key=${key}&limit=${limit}&offset=${offset}`);
    const data = await res.json();

    allInvoices = append ? [...allInvoices, ...data.invoices] : data.invoices;
    renderInvoices(allInvoices);
  }

  function renderInvoices(list) {
    const tbody = document.getElementById('invoiceTableBody');
    tbody.innerHTML = list.length
      ? list.map(inv => `
        <tr>
          <td><strong>${inv.id}</strong></td>
          <td>${new Date(inv.createdAt).toLocaleDateString('sk-SK')}</td>
          <td>${inv.customerName}<div class="subtext">${inv.customerEmail}</div></td>
          <td>${inv.productName}</td>
          <td class="amount">${inv.amount} ‚Ç¨</td>
          <td><span class="badge badge--success">Uhraden√°</span></td>
        </tr>`).join('')
      : `<tr><td colspan="6" class="emptyState">≈Ωiadne fakt√∫ry</td></tr>`;
  }

  function filterInvoices(q) {
    renderInvoices(allInvoices.filter(i =>
      Object.values(i).some(v => String(v).toLowerCase().includes(q))
    ));
  }

  // =====================
  // EMAIL CONTACTS
  // =====================
  let allContacts = [];
  let selectedContacts = [];

  async function loadEmailStats() {
    try {
      const res = await fetch('/api/contacts/stats', {
        headers: { Authorization: `Bearer ${adminPassword}` }
      });
      const d = await res.json();
      if (!d.ok) return;

      document.getElementById('emailStatTotal').textContent = d.total || 0;
      document.getElementById('emailStatWorkshops').textContent = d.workshop || 0;
      document.getElementById('emailStatContact').textContent = d.kontakt || 0;
      document.getElementById('emailStatCampaigns').textContent = d.campaigns || 0;
    } catch (e) {
      console.error('Stats error:', e);
    }
  }

  document.getElementById('loadContacts')?.addEventListener('click', async () => {
    try {
      const res = await fetch('/api/contacts/list', {
        headers: { Authorization: `Bearer ${adminPassword}` }
      });
      const d = await res.json();
      allContacts = d.contacts || [];
      renderContacts(allContacts);
      loadEmailStats();
    } catch (e) {
      console.error('Load contacts error:', e);
    }
  });

  function renderContacts(list) {
    const tbody = document.getElementById('contactsTableBody');
    tbody.innerHTML = list.length ? list.map(c => `
      <tr>
        <td><input type="checkbox" value="${c.email}" class="contact-checkbox" data-name="${c.name || ''}"></td>
        <td>${c.name || '-'}</td>
        <td>${c.email}</td>
        <td>${c.source || '-'}</td>
        <td>${c.tags ? c.tags.map(t => `<span class="tagBadge tagBadge--blue">${t}</span>`).join(' ') : '-'}</td>
        <td>${new Date(c.createdAt).toLocaleDateString('sk-SK')}</td>
        <td>
          <button class="btn btn--ghost btn--small" onclick="openNotesModal('${c.email}')">üìù</button>
        </td>
      </tr>
    `).join('') : '<tr><td colspan="7" class="emptyState">≈Ωiadne kontakty</td></tr>';

    document.querySelectorAll('.contact-checkbox').forEach(cb =>
      cb.addEventListener('change', updateSelectedContacts)
    );
  }

  function updateSelectedContacts() {
    selectedContacts = [...document.querySelectorAll('.contact-checkbox:checked')]
      .map(c => ({ email: c.value, name: c.dataset.name }));

    const countEl = document.getElementById('selectedCount');
    const actionsEl = document.getElementById('selectedActions');

    countEl.textContent = selectedContacts.length;
    actionsEl.style.display = selectedContacts.length > 0 ? 'block' : 'none';
  }

  // Select All checkbox
  document.getElementById('selectAll')?.addEventListener('change', e => {
    document.querySelectorAll('.contact-checkbox').forEach(cb => {
      cb.checked = e.target.checked;
    });
    updateSelectedContacts();
  });

  // =====================
  // CSV IMPORT
  // =====================
  let csvData = [];

  document.getElementById('importContactsBtn')?.addEventListener('click', () => {
    openModal('importModal');
    resetCsvImport();
  });

  function resetCsvImport() {
    csvData = [];
    document.getElementById('csvFileInput').value = '';
    document.getElementById('csvPreview').style.display = 'none';
    document.getElementById('confirmImportBtn').disabled = true;
    document.getElementById('csvErrors').innerHTML = '';
  }

  // File input change
  document.getElementById('csvFileInput')?.addEventListener('change', e => {
    const file = e.target.files[0];
    if (file) parseCSV(file);
  });

  // Drag and drop
  const dropZone = document.getElementById('fileDropZone');
  if (dropZone) {
    dropZone.addEventListener('dragover', e => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file && (file.name.endsWith('.csv') || file.name.endsWith('.txt'))) {
        parseCSV(file);
      } else {
        alert('Pros√≠m nahraj CSV s√∫bor.');
      }
    });
  }

  function parseCSV(file) {
    const reader = new FileReader();
    reader.onload = e => {
      const text = e.target.result;
      const delimiter = text.includes(';') ? ';' : ',';
      const lines = text.split('\n').filter(line => line.trim());

      if (lines.length < 2) {
        showCsvError('S√∫bor mus√≠ obsahova≈• hlaviƒçku a aspo≈à jeden riadok d√°t.');
        return;
      }

      const headers = lines[0].split(delimiter).map(h => h.trim().toLowerCase());

      // Validate headers
      const emailIndex = headers.findIndex(h => h === 'email' || h === 'e-mail');
      if (emailIndex === -1) {
        showCsvError('CSV mus√≠ obsahova≈• stƒ∫pec "email".');
        return;
      }

      const nameIndex = headers.findIndex(h => h === 'meno' || h === 'name' || h === 'meno a priezvisko');
      const sourceIndex = headers.findIndex(h => h === 'zdroj' || h === 'source');

      csvData = [];
      const errors = [];

      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(delimiter).map(v => v.trim().replace(/^"|"$/g, ''));
        const email = values[emailIndex];

        if (!email || !isValidEmail(email)) {
          errors.push(`Riadok ${i + 1}: Neplatn√Ω email "${email}"`);
          continue;
        }

        csvData.push({
          email: email,
          name: nameIndex !== -1 ? values[nameIndex] || '' : '',
          source: sourceIndex !== -1 ? values[sourceIndex] || 'import' : 'import'
        });
      }

      // Show preview
      showCsvPreview(csvData, errors);
    };
    reader.readAsText(file);
  }

  function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }

  function showCsvPreview(data, errors) {
    const preview = document.getElementById('csvPreview');
    const head = document.getElementById('csvPreviewHead');
    const body = document.getElementById('csvPreviewBody');
    const countEl = document.getElementById('csvRowCount');
    const errorsEl = document.getElementById('csvErrors');
    const importBtn = document.getElementById('confirmImportBtn');

    head.innerHTML = '<tr><th>Meno</th><th>Email</th><th>Zdroj</th></tr>';
    body.innerHTML = data.slice(0, 5).map(row => `
      <tr>
        <td>${row.name || '-'}</td>
        <td>${row.email}</td>
        <td>${row.source}</td>
      </tr>
    `).join('');

    countEl.textContent = `${data.length} kontaktov`;

    if (errors.length > 0) {
      errorsEl.innerHTML = `
        <div style="background:rgba(239,68,68,0.1); padding:0.75rem; border-radius:8px; color:#ef4444;">
          <strong>‚ö†Ô∏è ${errors.length} ch√Ωb:</strong><br>
          ${errors.slice(0, 3).join('<br>')}
          ${errors.length > 3 ? `<br>... a ${errors.length - 3} ƒèal≈°√≠ch` : ''}
        </div>
      `;
    } else {
      errorsEl.innerHTML = `
        <div style="background:rgba(34,197,94,0.1); padding:0.75rem; border-radius:8px; color:#22c55e;">
          ‚úÖ V≈°etky riadky s√∫ v poriadku
        </div>
      `;
    }

    preview.style.display = 'block';
    importBtn.disabled = data.length === 0;
  }

  function showCsvError(message) {
    const errorsEl = document.getElementById('csvErrors');
    errorsEl.innerHTML = `
      <div style="background:rgba(239,68,68,0.1); padding:0.75rem; border-radius:8px; color:#ef4444;">
        ‚ùå ${message}
      </div>
    `;
    document.getElementById('csvPreview').style.display = 'block';
  }

  // Confirm import
  document.getElementById('confirmImportBtn')?.addEventListener('click', async () => {
    if (csvData.length === 0) return;

    const btn = document.getElementById('confirmImportBtn');
    btn.disabled = true;
    btn.textContent = 'Importujem...';

    try {
      const res = await fetch('/api/contacts/import', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${adminPassword}`
        },
        body: JSON.stringify({ contacts: csvData })
      });

      const result = await res.json();

      if (result.ok) {
        alert(`‚úÖ Import √∫spe≈°n√Ω! Importovan√Ωch: ${result.imported} kontaktov`);
        closeModal('importModal');
        document.getElementById('loadContacts')?.click();
      } else {
        alert(`‚ùå Chyba: ${result.error}`);
      }
    } catch (e) {
      alert(`‚ùå Chyba pri importe: ${e.message}`);
    }

    btn.disabled = false;
    btn.textContent = 'Importova≈•';
  });

  // =====================
  // CAMPAIGN FORM
  // =====================
  document.getElementById('createCampaignBtn')?.addEventListener('click', () => {
    document.getElementById('campaignForm').style.display = 'block';
  });

  document.getElementById('cancelCampaign')?.addEventListener('click', () => {
    document.getElementById('campaignForm').style.display = 'none';
  });

  // Template selection
  document.getElementById('campaignTemplate')?.addEventListener('change', e => {
    const customField = document.getElementById('customContentField');
    const template = emailTemplates[e.target.value];

    if (e.target.value === 'custom') {
      customField.style.display = 'block';
    } else {
      customField.style.display = 'none';
      if (template) {
        document.getElementById('campaignSubject').value = template.subject;
        document.getElementById('campaignContent').value = template.content;
      }
    }
  });

  // Segment selection
  document.getElementById('campaignSegment')?.addEventListener('change', e => {
    const tagField = document.getElementById('tagSegmentField');
    tagField.style.display = e.target.value === 'tag' ? 'block' : 'none';
  });

  // Schedule selection
  document.getElementById('campaignSchedule')?.addEventListener('change', e => {
    const scheduleField = document.getElementById('scheduleTimeField');
    scheduleField.style.display = e.target.value === 'scheduled' ? 'block' : 'none';
  });

  // =====================
  // EMAIL PREVIEW
  // =====================
  document.getElementById('previewEmailBtn')?.addEventListener('click', () => {
    showEmailPreview();
  });

  function showEmailPreview() {
    const subject = document.getElementById('campaignSubject').value || 'Bez predmetu';
    const templateKey = document.getElementById('campaignTemplate').value;
    let content = '';

    if (templateKey === 'custom') {
      content = document.getElementById('campaignContent').value || '<p>Pr√°zdny email</p>';
    } else if (emailTemplates[templateKey]) {
      content = emailTemplates[templateKey].content;
    }

    // Apply personalization with sample data
    const sampleData = { meno: 'J√°n Nov√°k', email: 'jan.novak@email.sk' };

    document.getElementById('previewSubject').textContent = personalize(subject, sampleData);
    document.getElementById('previewBody').innerHTML = personalize(content, sampleData);

    openModal('previewModal');
  }

  // Preview toggle (Desktop/Mobile)
  document.querySelectorAll('.previewToggle').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.previewToggle').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      const preview = document.getElementById('emailPreviewContent');
      if (btn.dataset.view === 'mobile') {
        preview.style.maxWidth = '375px';
        preview.style.margin = '0 auto';
      } else {
        preview.style.maxWidth = 'none';
        preview.style.margin = '0';
      }
    });
  });

  // =====================
  // TEST EMAIL
  // =====================
  document.getElementById('sendTestEmailBtn')?.addEventListener('click', () => {
    openModal('testEmailModal');
  });

  document.getElementById('sendTestFromPreview')?.addEventListener('click', () => {
    closeModal('previewModal');
    openModal('testEmailModal');
  });

  document.getElementById('confirmTestEmail')?.addEventListener('click', async () => {
    const testEmail = document.getElementById('testEmailAddress').value;
    if (!testEmail || !isValidEmail(testEmail)) {
      alert('Zadaj platn√∫ emailov√∫ adresu.');
      return;
    }

    const subject = document.getElementById('campaignSubject').value;
    const templateKey = document.getElementById('campaignTemplate').value;
    let content = templateKey === 'custom'
      ? document.getElementById('campaignContent').value
      : emailTemplates[templateKey]?.content || '';

    // Personalize with test data
    const testData = { meno: 'J√°n Nov√°k', email: testEmail };

    const btn = document.getElementById('confirmTestEmail');
    btn.disabled = true;
    btn.textContent = 'Odosielam...';

    try {
      const res = await fetch('/api/email/send-test', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${adminPassword}`
        },
        body: JSON.stringify({
          to: testEmail,
          subject: personalize(subject, testData),
          html: personalize(content, testData)
        })
      });

      const result = await res.json();
      if (result.ok) {
        alert(`‚úÖ Test email odoslan√Ω na ${testEmail}`);
        closeModal('testEmailModal');
      } else {
        alert(`‚ùå Chyba: ${result.error}`);
      }
    } catch (e) {
      alert(`‚ùå Chyba: ${e.message}`);
    }

    btn.disabled = false;
    btn.textContent = 'Odosla≈• test';
  });

  // =====================
  // EXPORT CSV
  // =====================
  document.getElementById('exportContacts')?.addEventListener('click', () => {
    if (allContacts.length === 0) {
      alert('Najprv naƒç√≠taj kontakty.');
      return;
    }

    const csv = [
      'Meno,Email,Zdroj,D√°tum',
      ...allContacts.map(c =>
        `"${c.name || ''}","${c.email}","${c.source || ''}","${new Date(c.createdAt).toLocaleDateString('sk-SK')}"`
      )
    ].join('\n');

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `kontakty-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  });

  // =====================
  // AUTOMATIONS
  // =====================
  window.editAutomation = type => {
    const automations = {
      welcome: {
        name: 'Welcome email',
        subject: 'Vitaj {meno}!',
        content: '<h1>Ahoj {meno}!</h1><p>Vitaj v na≈°ej komunite.</p>',
        active: true
      },
      followup: {
        name: 'Workshop follow-up',
        subject: 'Ako sa ti p√°ƒçil workshop, {meno}?',
        content: '<p>Ahoj {meno}, d√∫fame ≈æe workshop bol pre teba pr√≠nosn√Ω.</p>',
        active: true
      },
      reengagement: {
        name: 'Re-engagement',
        subject: '{meno}, dlho sme sa nevideli!',
        content: '<p>Ahoj {meno}, m√°me pre teba novinky!</p>',
        active: false
      }
    };

    const a = automations[type] || automations.welcome;

    document.getElementById('editAutoId').value = type;
    document.getElementById('editAutoName').value = a.name;
    document.getElementById('editAutoSubject').value = a.subject;
    document.getElementById('editAutoContent').value = a.content;
    document.getElementById('editAutoActive').checked = a.active;

    openModal('editAutomationModal');
  };

  document.getElementById('createAutomationBtn')?.addEventListener('click', () => {
    openModal('createAutomationModal');
  });

  // =====================
  // TEMPLATE FUNCTIONS
  // =====================
  window.previewTemplate = (templateKey) => {
    const template = emailTemplates[templateKey];
    if (!template) return;

    const sampleData = { meno: 'J√°n Nov√°k', email: 'jan.novak@email.sk' };
    document.getElementById('previewSubject').textContent = personalize(template.subject, sampleData);
    document.getElementById('previewBody').innerHTML = personalize(template.content, sampleData);
    openModal('previewModal');
  };

  window.useTemplate = (templateKey) => {
    document.querySelector('[data-subtab="campaigns"]')?.click();
    document.getElementById('createCampaignBtn')?.click();
    document.getElementById('campaignTemplate').value = templateKey;
    document.getElementById('campaignTemplate').dispatchEvent(new Event('change'));
  };

  window.selectCustomTemplate = () => {
    document.querySelector('[data-subtab="campaigns"]')?.click();
    document.getElementById('createCampaignBtn')?.click();
    document.getElementById('campaignTemplate').value = 'custom';
    document.getElementById('customContentField').style.display = 'block';
  };

  // =====================
  // NOTES MODAL
  // =====================
  window.openNotesModal = (email) => {
    document.getElementById('notesContactEmail').textContent = email;
    openModal('notesModal');
  };

  // =====================
  // MODALS
  // =====================
  window.openModal = id => document.getElementById(id).style.display = 'flex';
  window.closeModal = id => document.getElementById(id).style.display = 'none';

  // Close modal on backdrop click
  document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', e => {
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    });
  });

  // Load initial stats
  loadEmailStats();
});
</script>

<style>
/* ========== ADMIN TABS ========== */
.adminTabs {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 2rem;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  padding-bottom: 1rem;
}

.adminTab {
  padding: 0.75rem 1.5rem;
  background: transparent;
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 8px;
  color: rgba(255,255,255,0.7);
  cursor: pointer;
  transition: all 0.2s;
  font-family: inherit;
  font-size: 1rem;
}

.adminTab:hover {
  background: rgba(255,255,255,0.05);
  color: white;
}

.adminTab.active {
  background: #f97316;
  border-color: #f97316;
  color: white;
}

.tabContent {
  display: none;
}

.tabContent.active {
  display: block;
}

/* ========== SUB TABS ========== */
.subTabs {
  display: flex;
  gap: 0.5rem;
  margin: 2rem 0 1.5rem;
  flex-wrap: wrap;
}

.subTab {
  padding: 0.5rem 1rem;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 6px;
  color: rgba(255,255,255,0.6);
  cursor: pointer;
  font-size: 0.875rem;
  font-family: inherit;
  transition: all 0.2s;
}

.subTab:hover {
  background: rgba(255,255,255,0.1);
  color: white;
}

.subTab.active {
  background: rgba(249,115,22,0.2);
  border-color: #f97316;
  color: #f97316;
}

.subTabContent {
  display: none;
}

.subTabContent.active {
  display: block;
}

/* ========== STATS GRID ========== */
.statsGrid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-bottom: 2rem;
}

.statCard {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 12px;
  padding: 1.5rem;
  text-align: center;
}

.statValue {
  display: block;
  font-size: 2rem;
  font-weight: 700;
  color: #f97316;
  margin-bottom: 0.25rem;
}

.statLabel {
  color: rgba(255,255,255,0.6);
  font-size: 0.875rem;
}

/* ========== FORMS ========== */
.formCard {
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 12px;
  padding: 2rem;
}

.formGrid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1.5rem;
}

.field {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.field.fieldFull {
  grid-column: 1 / -1;
}

.field label {
  font-size: 0.875rem;
  color: rgba(255,255,255,0.7);
}

.field label code {
  background: rgba(249,115,22,0.2);
  color: #f97316;
  padding: 0.1rem 0.3rem;
  border-radius: 4px;
  font-size: 0.8rem;
}

.field input,
.field select,
.field textarea {
  padding: 0.75rem 1rem;
  background: rgba(0,0,0,0.3);
  border: 1px solid rgba(255,255,255,0.15);
  border-radius: 8px;
  color: white;
  font-size: 1rem;
  font-family: inherit;
  transition: border-color 0.2s;
}

.field input:focus,
.field select:focus,
.field textarea:focus {
  outline: none;
  border-color: #f97316;
}

.field select {
  cursor: pointer;
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23ffffff' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 1rem center;
  padding-right: 2.5rem;
}

.field select option {
  background: #1a1a1a;
  color: white;
}

.formActions {
  display: flex;
  gap: 1rem;
  margin-top: 1.5rem;
  flex-wrap: wrap;
}

/* ========== CONTROLS ========== */
.invoiceControls,
.emailControls {
  display: flex;
  gap: 1rem;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
  align-items: center;
}

.searchInput {
  flex: 1;
  min-width: 200px;
  padding: 0.75rem 1rem;
  background: rgba(0,0,0,0.3);
  border: 1px solid rgba(255,255,255,0.15);
  border-radius: 8px;
  color: white;
  font-size: 0.875rem;
  font-family: inherit;
}

.searchInput::placeholder {
  color: rgba(255,255,255,0.4);
}

.searchInput:focus {
  outline: none;
  border-color: #f97316;
}

.filterSelect {
  padding: 0.75rem 1rem;
  background: rgba(0,0,0,0.3);
  border: 1px solid rgba(255,255,255,0.15);
  border-radius: 8px;
  color: white;
  cursor: pointer;
  font-family: inherit;
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23ffffff' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 0.75rem center;
  padding-right: 2rem;
}

.filterSelect option {
  background: #1a1a1a;
  color: white;
}

/* ========== TABLES ========== */
.tableWrapper {
  overflow-x: auto;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.1);
}

.invoiceTable {
  width: 100%;
  border-collapse: collapse;
}

.invoiceTable th,
.invoiceTable td {
  padding: 1rem;
  text-align: left;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

.invoiceTable th {
  background: rgba(255,255,255,0.05);
  font-weight: 600;
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: rgba(255,255,255,0.6);
}

.invoiceTable td {
  font-size: 0.875rem;
}

.invoiceTable tbody tr:hover {
  background: rgba(255,255,255,0.02);
}

.emptyState {
  text-align: center;
  color: rgba(255,255,255,0.4);
  padding: 3rem !important;
}

.subtext {
  font-size: 0.75rem;
  color: rgba(255,255,255,0.5);
  margin-top: 0.25rem;
}

.amount {
  font-weight: 600;
  color: #22c55e;
}

/* ========== BADGES ========== */
.badge {
  display: inline-block;
  padding: 0.25rem 0.75rem;
  border-radius: 999px;
  font-size: 0.75rem;
  font-weight: 500;
}

.badge--success {
  background: rgba(34,197,94,0.2);
  color: #22c55e;
}

/* ========== STEPS ========== */
.stepsGrid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 1rem;
}

.stepCard {
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 12px;
  padding: 1.5rem;
  text-align: center;
}

.stepNum {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 2rem;
  height: 2rem;
  background: #f97316;
  border-radius: 50%;
  font-weight: 700;
  margin-bottom: 0.75rem;
}

.stepCard h4 {
  margin-bottom: 0.5rem;
}

.stepCard p {
  font-size: 0.875rem;
  color: rgba(255,255,255,0.6);
  margin: 0;
}

/* ========== TEMPLATES ========== */
.templatesGrid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1rem;
}

.templateCard {
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 12px;
  padding: 1.5rem;
}

.templateCard h4 {
  margin: 0 0 0.5rem 0;
  color: #f97316;
}

.templateCard p {
  font-size: 0.875rem;
  color: rgba(255,255,255,0.6);
  margin: 0 0 1rem 0;
}

/* ========== TAGS ========== */
.tagsGrid {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.tagItem {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 0.75rem 1rem;
  background: rgba(255,255,255,0.03);
  border-radius: 8px;
}

.tagBadge {
  padding: 0.25rem 0.75rem;
  border-radius: 999px;
  font-size: 0.75rem;
  font-weight: 600;
}

.tagBadge--blue { background: rgba(59,130,246,0.2); color: #3b82f6; }
.tagBadge--green { background: rgba(34,197,94,0.2); color: #22c55e; }
.tagBadge--orange { background: rgba(249,115,22,0.2); color: #f97316; }
.tagBadge--purple { background: rgba(168,85,247,0.2); color: #a855f7; }
.tagBadge--red { background: rgba(239,68,68,0.2); color: #ef4444; }

.tagCount {
  flex: 1;
  font-size: 0.875rem;
  color: rgba(255,255,255,0.6);
}

/* ========== AUTOMATION ========== */
.automationCards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 1rem;
}

.automationCard {
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 12px;
  padding: 1.5rem;
}

.automationHeader {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.75rem;
}

.automationHeader h4 {
  margin: 0;
  color: #f97316;
}

.automationCard > p {
  font-size: 0.875rem;
  color: rgba(255,255,255,0.6);
  margin: 0 0 1rem 0;
}

.automationStats {
  display: flex;
  gap: 1.5rem;
  font-size: 0.75rem;
  color: rgba(255,255,255,0.5);
  margin-bottom: 1rem;
}

/* ========== TOGGLE ========== */
.toggle {
  position: relative;
  display: inline-block;
  width: 48px;
  height: 26px;
}

.toggle input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  inset: 0;
  background: rgba(255,255,255,0.2);
  border-radius: 999px;
  transition: 0.3s;
}

.slider::before {
  content: "";
  position: absolute;
  height: 20px;
  width: 20px;
  left: 3px;
  bottom: 3px;
  background: white;
  border-radius: 50%;
  transition: 0.3s;
}

.toggle input:checked + .slider {
  background: #f97316;
}

.toggle input:checked + .slider::before {
  transform: translateX(22px);
}

/* ========== MODALS ========== */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 1rem;
}

.modalContent {
  background: #1a1a1a;
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 16px;
  width: 100%;
  max-width: 500px;
  max-height: 90vh;
  overflow-y: auto;
}

.modalContent.modalLarge {
  max-width: 800px;
}

.modalHeader {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1.5rem;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  gap: 1rem;
}

.modalHeader h3 {
  margin: 0;
  flex: 1;
}

.modalClose {
  background: none;
  border: none;
  color: rgba(255,255,255,0.6);
  font-size: 1.5rem;
  cursor: pointer;
  line-height: 1;
  padding: 0;
}

.modalClose:hover {
  color: white;
}

.modalBody {
  padding: 1.5rem;
}

.modalFooter {
  display: flex;
  justify-content: flex-end;
  gap: 1rem;
  padding: 1.5rem;
  border-top: 1px solid rgba(255,255,255,0.1);
}

/* ========== EMAIL PREVIEW ========== */
.emailPreview {
  background: white;
  color: #333;
  border-radius: 8px;
  overflow: hidden;
  transition: max-width 0.3s;
}

.emailPreviewHeader {
  background: #f5f5f5;
  padding: 1rem;
  font-size: 0.875rem;
  border-bottom: 1px solid #ddd;
  line-height: 1.6;
}

.emailPreviewBody {
  padding: 1.5rem;
}

.previewToggle {
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.2);
  color: rgba(255,255,255,0.6);
  padding: 0.4rem 0.75rem;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.75rem;
}

.previewToggle.active {
  background: #f97316;
  border-color: #f97316;
  color: white;
}

/* ========== FILE DROP ZONE ========== */
.fileDropZone {
  border: 2px dashed rgba(255,255,255,0.2);
  border-radius: 12px;
  padding: 2rem;
  text-align: center;
  transition: all 0.2s;
  cursor: pointer;
}

.fileDropZone:hover,
.fileDropZone.dragover {
  border-color: #f97316;
  background: rgba(249,115,22,0.05);
}

.dropZoneContent p {
  margin: 0.5rem 0 0 0;
  color: rgba(255,255,255,0.6);
}

/* ========== BUTTONS ========== */
.btn--small {
  padding: 0.4rem 0.75rem;
  font-size: 0.75rem;
}

/* ========== HELPERS ========== */
.help {
  font-size: 0.875rem;
  color: rgba(255,255,255,0.5);
  margin-top: 0.5rem;
}

pre {
  background: rgba(0,0,0,0.5);
  padding: 1rem;
  border-radius: 8px;
  overflow-x: auto;
  font-size: 0.875rem;
}

code {
  background: rgba(0,0,0,0.3);
  padding: 0.15rem 0.4rem;
  border-radius: 4px;
}

/* ========== CHECKBOX STYLING ========== */
.invoiceTable input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: #f97316;
}

/* ========== RESPONSIVE ========== */
@media (max-width: 768px) {
  .adminTabs {
    flex-wrap: wrap;
  }

  .adminTab {
    flex: 1;
    min-width: 100px;
    text-align: center;
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
  }

  .formGrid {
    grid-template-columns: 1fr;
  }

  .statsGrid {
    grid-template-columns: repeat(2, 1fr);
  }

  .emailControls {
    flex-direction: column;
  }

  .searchInput {
    width: 100%;
  }

  .filterSelect {
    width: 100%;
  }

  .modalHeader {
    flex-wrap: wrap;
  }
}
</style>
