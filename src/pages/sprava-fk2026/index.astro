---
import BaseLayout from "../../layouts/BaseLayout.astro";
---

<BaseLayout title="Admin | Spr√°va" noindex={true}>
  <section class="heroSection">
    <div class="heroContent">
      <h1>Spr√°va FerkoMedia</h1>
      <p class="heroLead">Fakt√∫ry, workshopy, email marketing</p>
    </div>
  </section>

  <!-- TABS -->
  <section class="section">
    <div class="adminTabs">
      <button class="adminTab active" data-tab="invoices">Fakt√∫ry</button>
      <button class="adminTab" data-tab="workshops">Workshopy</button>
      <button class="adminTab" data-tab="email">Email Marketing</button>
    </div>

    <!-- FAKT√öRY TAB -->
    <div class="tabContent active" id="tab-invoices">
      <div class="statsGrid">
        <div class="statCard">
          <span class="statValue" id="statTotal">-</span>
          <span class="statLabel">Fakt√∫r celkom</span>
        </div>
        <div class="statCard">
          <span class="statValue" id="statRevenue">-</span>
          <span class="statLabel">Celkov√Ω pr√≠jem</span>
        </div>
        <div class="statCard">
          <span class="statValue" id="statMonthCount">-</span>
          <span class="statLabel">Tento mesiac</span>
        </div>
        <div class="statCard">
          <span class="statValue" id="statMonthRevenue">-</span>
          <span class="statLabel">Pr√≠jem tento mesiac</span>
        </div>
      </div>

      <div class="invoiceControls">
        <input type="text" id="searchInvoice" placeholder="Hƒæada≈• podƒæa mena, emailu, IƒåO..." class="searchInput" />
        <button class="btn btn--primary" id="loadInvoices">Naƒç√≠ta≈• fakt√∫ry</button>
      </div>

      <div class="tableWrapper">
        <table class="invoiceTable">
          <thead>
            <tr>
              <th>ƒå√≠slo</th>
              <th>D√°tum</th>
              <th>Z√°kazn√≠k</th>
              <th>Firma / IƒåO</th>
              <th>Produkt</th>
              <th>Suma</th>
              <th>Stav</th>
            </tr>
          </thead>
          <tbody id="invoiceTableBody">
            <tr>
              <td colspan="7" class="emptyState">Klikni na "Naƒç√≠ta≈• fakt√∫ry" pre zobrazenie</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="loadMoreWrapper" style="display:none; text-align:center; margin-top:1rem;">
        <button class="btn btn--ghost" id="loadMore">Naƒç√≠ta≈• ƒèal≈°ie</button>
      </div>
    </div>

    <!-- WORKSHOPY TAB -->
    <div class="tabContent" id="tab-workshops">
      <h2>Prida≈• nov√Ω term√≠n</h2>
      <div class="formCard">
        <form id="addTermForm">
          <div class="formGrid">
            <div class="field">
              <label for="title">Typ workshopu</label>
              <select id="title" required>
                <option value="">Vyber typ</option>
                <option value="Web za 1 de≈à">Web za 1 de≈à</option>
                <option value="E-shop za 1 de≈à">E-shop za 1 de≈à</option>
                <option value="Google reklama za 1 de≈à">Google reklama za 1 de≈à</option>
                <option value="Soci√°lne siete za 1 de≈à">Soci√°lne siete za 1 de≈à</option>
                <option value="AI n√°stroje za 1 de≈à">AI n√°stroje za 1 de≈à</option>
              </select>
            </div>

            <div class="field">
              <label for="date">D√°tum</label>
              <input id="date" type="text" placeholder="DD.MM.RRRR" required />
            </div>

            <div class="field">
              <label for="city">Mesto</label>
              <input id="city" type="text" value="Martin" required />
            </div>

            <div class="field">
              <label for="price">Cena (‚Ç¨)</label>
              <input id="price" type="number" value="149" required />
            </div>

            <div class="field">
              <label for="capacity">Kapacita</label>
              <input id="capacity" type="number" value="12" required />
            </div>

            <div class="field">
              <label for="status">Status</label>
              <select id="status">
                <option value="open">Otvoren√Ω</option>
                <option value="closed">Zatvoren√Ω</option>
              </select>
            </div>
          </div>

          <div class="formActions">
            <button type="submit" class="btn btn--primary">Generova≈• JSON</button>
          </div>
        </form>

        <div id="jsonOutput" style="display:none; margin-top:1.5rem;">
          <h3>Nov√Ω JSON z√°znam:</h3>
          <pre id="jsonCode"></pre>
          <p class="help">Skop√≠ruj tento z√°znam a pridaj ho do s√∫boru src/data/workshop-terms.json</p>
        </div>
      </div>

      <h2 style="margin-top:3rem;">Ako upravi≈• term√≠ny</h2>
      <div class="stepsGrid">
        <div class="stepCard">
          <span class="stepNum">1</span>
          <h4>Otvor s√∫bor</h4>
          <p>src/data/workshop-terms.json</p>
        </div>
        <div class="stepCard">
          <span class="stepNum">2</span>
          <h4>Uprav JSON</h4>
          <p>Pridaj, zme≈à alebo odstr√°≈à term√≠ny.</p>
        </div>
        <div class="stepCard">
          <span class="stepNum">3</span>
          <h4>Commit a Push</h4>
          <p>git add . && git commit && git push</p>
        </div>
        <div class="stepCard">
          <span class="stepNum">4</span>
          <h4>Hotovo</h4>
          <p>Cloudflare automaticky deployuje.</p>
        </div>
      </div>
    </div>

    <!-- EMAIL MARKETING TAB -->
    <div class="tabContent" id="tab-email">
      <!-- Stats -->
      <div class="statsGrid">
        <div class="statCard">
          <span class="statValue" id="emailStatTotal">-</span>
          <span class="statLabel">Kontaktov celkom</span>
        </div>
        <div class="statCard">
          <span class="statValue" id="emailStatWorkshops">-</span>
          <span class="statLabel">Z workshopov</span>
        </div>
        <div class="statCard">
          <span class="statValue" id="emailStatContact">-</span>
          <span class="statLabel">Z kontaktu</span>
        </div>
        <div class="statCard">
          <span class="statValue" id="emailStatCampaigns">-</span>
          <span class="statLabel">Odoslan√Ωch kampan√≠</span>
        </div>
      </div>

      <!-- Sub-tabs -->
      <div class="subTabs">
        <button class="subTab active" data-subtab="contacts">Kontakty</button>
        <button class="subTab" data-subtab="campaigns">Kampane</button>
        <button class="subTab" data-subtab="templates">≈†abl√≥ny</button>
        <button class="subTab" data-subtab="tags">Tagy</button>
        <button class="subTab" data-subtab="automation">Automatiz√°cia</button>
      </div>

      <!-- CONTACTS SUBTAB -->
      <div class="subTabContent active" id="subtab-contacts">
        <div class="emailControls">
          <input type="text" id="searchContacts" placeholder="Hƒæada≈• kontakty..." class="searchInput" />
          <select id="filterSource" class="filterSelect">
            <option value="">V≈°etky zdroje</option>
            <option value="workshop">Workshop</option>
            <option value="kontakt">Kontakt</option>
            <option value="dlhodoba-spolupraca">Dlhodob√° spolupr√°ca</option>
          </select>
          <select id="filterTag" class="filterSelect">
            <option value="">V≈°etky tagy</option>
            <option value="VIP">VIP</option>
            <option value="Z√°ujemca">Z√°ujemca</option>
            <option value="K√∫pil">K√∫pil</option>
          </select>
          <button class="btn btn--primary" id="loadContacts">Naƒç√≠ta≈• kontakty</button>
          <button class="btn btn--ghost" id="exportContacts">Export CSV</button>
          <button class="btn btn--ghost" id="importContactsBtn">üì• Import CSV</button>
        </div>

        <div class="tableWrapper">
          <table class="invoiceTable">
            <thead>
              <tr>
                <th><input type="checkbox" id="selectAll" /></th>
                <th>Meno</th>
                <th>Email</th>
                <th>Zdroj</th>
                <th>Tagy</th>
                <th>D√°tum</th>
                <th>Akcie</th>
              </tr>
            </thead>
            <tbody id="contactsTableBody">
              <tr>
                <td colspan="7" class="emptyState">Klikni na "Naƒç√≠ta≈• kontakty"</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div id="selectedActions" style="display:none; margin-top:1rem; padding:1rem; background:rgba(249,115,22,0.1); border-radius:8px;">
          <span id="selectedCount">0</span> oznaƒçen√Ωch kontaktov
          <button class="btn btn--primary btn--small" id="sendToSelected" style="margin-left:1rem;">Odosla≈• kampa≈à</button>
          <button class="btn btn--ghost btn--small" id="addTagToSelected">Prida≈• tag</button>
          <button class="btn btn--ghost btn--small" id="deleteSelected">Vymaza≈•</button>
        </div>
      </div>

      <!-- CAMPAIGNS SUBTAB -->
      <div class="subTabContent" id="subtab-campaigns">
        <button class="btn btn--primary" id="createCampaignBtn" style="margin-bottom:2rem;">+ Vytvori≈• nov√∫ kampa≈à</button>

        <div id="campaignForm" style="display:none;" class="formCard">
          <h3>Nov√° kampa≈à</h3>
          <form id="newCampaignForm">
            <div class="formGrid">
              <div class="field fieldFull">
                <label for="campaignName">N√°zov kampane</label>
                <input id="campaignName" type="text" placeholder="Napr. Zimn√° ponuka 2026" required />
              </div>

              <div class="field fieldFull">
                <label for="campaignSubject">Predmet emailu (m√¥≈æe≈° pou≈æi≈• &#123;meno&#125;, &#123;email&#125;)</label>
                <input id="campaignSubject" type="text" placeholder="Ahoj, m√°me pre teba novinky!" required />
              </div>

              <div class="field fieldFull">
                <label for="campaignTemplate">≈†abl√≥na</label>
                <select id="campaignTemplate" required>
                  <option value="">Vyber ≈°abl√≥nu</option>
                  <option value="newsletter">Newsletter</option>
                  <option value="workshop-promo">Workshop propag√°cia</option>
                  <option value="custom">Vlastn√Ω text</option>
                </select>
              </div>

              <div class="field fieldFull" id="customContentField" style="display:none;">
                <label for="campaignContent">Obsah emailu (HTML) - m√¥≈æe≈° pou≈æi≈• &#123;meno&#125;, &#123;email&#125;</label>
                <textarea id="campaignContent" rows="10" placeholder="<h1>Ahoj!</h1><p>Text...</p>"></textarea>
              </div>

              <div class="field fieldFull">
                <label for="campaignSegment">Komu odosla≈•?</label>
                <select id="campaignSegment">
                  <option value="all">V≈°etk√Ωm kontaktom</option>
                  <option value="workshop">Len workshopom</option>
                  <option value="kontakt">Len kontaktu</option>
                  <option value="selected">Oznaƒçen√Ωm kontaktom</option>
                  <option value="tag">Podƒæa tagu</option>
                </select>
              </div>

              <div class="field fieldFull" id="tagSegmentField" style="display:none;">
                <label for="campaignTag">Vyber tag</label>
                <select id="campaignTag">
                  <option value="VIP">VIP</option>
                  <option value="Z√°ujemca">Z√°ujemca</option>
                  <option value="K√∫pil">K√∫pil</option>
                </select>
              </div>

              <div class="field fieldFull">
                <label for="campaignSchedule">Odoslanie</label>
                <select id="campaignSchedule">
                  <option value="now">Odosla≈• hneƒè</option>
                  <option value="scheduled">Napl√°nova≈• na nesk√¥r</option>
                </select>
              </div>

              <div class="field fieldFull" id="scheduleTimeField" style="display:none;">
                <label for="campaignDateTime">D√°tum a ƒças odoslania</label>
                <input id="campaignDateTime" type="datetime-local" />
              </div>
            </div>

            <div class="formActions">
              <button type="button" class="btn btn--ghost" id="previewEmailBtn">üëÅÔ∏è N√°hƒæad</button>
              <button type="button" class="btn btn--ghost" id="sendTestEmailBtn">üìß Test email</button>
              <button type="submit" class="btn btn--primary">Vytvori≈• a odosla≈•</button>
              <button type="button" class="btn btn--ghost" id="cancelCampaign">Zru≈°i≈•</button>
            </div>
          </form>
        </div>

        <h3 style="margin-top:2rem;">Hist√≥ria kampan√≠</h3>
        <div class="tableWrapper">
          <table class="invoiceTable">
            <thead>
              <tr>
                <th>N√°zov</th>
                <th>Predmet</th>
                <th>Odoslan√Ωch</th>
                <th>Open Rate</th>
                <th>Click Rate</th>
                <th>D√°tum</th>
                <th>Akcie</th>
              </tr>
            </thead>
            <tbody id="campaignsTableBody">
              <tr>
                <td colspan="7" class="emptyState">≈Ωiadne kampane</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- TEMPLATES SUBTAB -->
      <div class="subTabContent" id="subtab-templates">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
          <h3>Email ≈°abl√≥ny</h3>
          <button class="btn btn--primary" id="createCustomTemplateBtn">+ Vytvori≈• vlastn√∫ ≈°abl√≥nu</button>
        </div>

        <div class="templatesGrid">
          <div class="templateCard">
            <h4>Newsletter</h4>
            <p>Z√°kladn√° ≈°abl√≥na pre newsletter s novinkami a ponukami.</p>
            <div style="display:flex; gap:0.5rem;">
              <button class="btn btn--ghost btn--small" onclick="previewTemplate('newsletter')">N√°hƒæad</button>
              <button class="btn btn--ghost btn--small" onclick="useTemplate('newsletter')">Pou≈æi≈•</button>
            </div>
          </div>
          <div class="templateCard">
            <h4>Workshop propag√°cia</h4>
            <p>≈†abl√≥na na propag√°ciu nadch√°dzaj√∫cich workshopov.</p>
            <div style="display:flex; gap:0.5rem;">
              <button class="btn btn--ghost btn--small" onclick="previewTemplate('workshop-promo')">N√°hƒæad</button>
              <button class="btn btn--ghost btn--small" onclick="useTemplate('workshop-promo')">Pou≈æi≈•</button>
            </div>
          </div>
          <div class="templateCard">
            <h4>Vlastn√Ω</h4>
            <p>Vytvor si vlastn√Ω email s HTML k√≥dom.</p>
            <div style="display:flex; gap:0.5rem;">
              <button class="btn btn--ghost btn--small" onclick="selectCustomTemplate()">Pou≈æi≈•</button>
            </div>
          </div>
          <div id="customTemplatesContainer"></div>
        </div>
      </div>

      <!-- TAGS SUBTAB -->
      <div class="subTabContent" id="subtab-tags">
        <h3>Spr√°va tagov</h3>
        <div class="formCard">
          <form id="createTagForm">
            <div class="formGrid">
              <div class="field">
                <label for="tagName">N√°zov tagu</label>
                <input id="tagName" type="text" placeholder="Napr. VIP, Z√°ujemca" required />
              </div>
              <div class="field">
                <label for="tagColor">Farba</label>
                <select id="tagColor">
                  <option value="blue">Modr√°</option>
                  <option value="green">Zelen√°</option>
                  <option value="orange">Oran≈æov√°</option>
                  <option value="purple">Fialov√°</option>
                  <option value="red">ƒåerven√°</option>
                </select>
              </div>
            </div>
            <div class="formActions">
              <button type="submit" class="btn btn--primary">Vytvori≈• tag</button>
            </div>
          </form>
        </div>

        <h4 style="margin-top:2rem;">Existuj√∫ce tagy</h4>
        <div class="tagsGrid" id="existingTags">
          <div class="tagItem">
            <span class="tagBadge tagBadge--blue">VIP</span>
            <span class="tagCount">12 kontaktov</span>
            <button class="btn btn--ghost btn--small" onclick="deleteTag('VIP')">Vymaza≈•</button>
          </div>
          <div class="tagItem">
            <span class="tagBadge tagBadge--green">Z√°ujemca</span>
            <span class="tagCount">34 kontaktov</span>
            <button class="btn btn--ghost btn--small" onclick="deleteTag('Z√°ujemca')">Vymaza≈•</button>
          </div>
          <div class="tagItem">
            <span class="tagBadge tagBadge--orange">K√∫pil</span>
            <span class="tagCount">89 kontaktov</span>
            <button class="btn btn--ghost btn--small" onclick="deleteTag('K√∫pil')">Vymaza≈•</button>
          </div>
        </div>
      </div>

      <!-- AUTOMATION SUBTAB -->
      <div class="subTabContent" id="subtab-automation">
        <h3>Automatick√© kampane</h3>
        <button class="btn btn--primary" id="createAutomationBtn" style="margin-bottom:2rem;">+ Vytvori≈• automatiz√°ciu</button>

        <div class="automationCards">
          <div class="automationCard">
            <div class="automationHeader">
              <h4>Welcome email</h4>
              <label class="toggle">
                <input type="checkbox" checked />
                <span class="slider"></span>
              </label>
            </div>
            <p>Automaticky odo≈°le welcome email nov√Ωm kontaktom</p>
            <div class="automationStats">
              <span>Trigger: Nov√Ω kontakt</span>
              <span>Odoslan√Ωch: 156</span>
            </div>
            <button class="btn btn--ghost btn--small" onclick="editAutomation('welcome')">Upravi≈•</button>
          </div>

          <div class="automationCard">
            <div class="automationHeader">
              <h4>Workshop follow-up</h4>
              <label class="toggle">
                <input type="checkbox" checked />
                <span class="slider"></span>
              </label>
            </div>
            <p>Odo≈°le email 3 dni po workshope</p>
            <div class="automationStats">
              <span>Trigger: Po workshope (+3 dni)</span>
              <span>Odoslan√Ωch: 89</span>
            </div>
            <button class="btn btn--ghost btn--small" onclick="editAutomation('followup')">Upravi≈•</button>
          </div>

          <div class="automationCard">
            <div class="automationHeader">
              <h4>Re-engagement</h4>
              <label class="toggle">
                <input type="checkbox" />
                <span class="slider"></span>
              </label>
            </div>
            <p>Aktivuje kontakty po 30 d≈àoch neƒçinnosti</p>
            <div class="automationStats">
              <span>Trigger: 30 dn√≠ bez aktivity</span>
              <span>Odoslan√Ωch: 23</span>
            </div>
            <button class="btn btn--ghost btn--small" onclick="editAutomation('reengagement')">Upravi≈•</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- MODALS -->
  <!-- Import CSV Modal -->
  <div id="importModal" class="modal" style="display:none;">
    <div class="modalContent">
      <div class="modalHeader">
        <h3>Import kontaktov z CSV</h3>
        <button class="modalClose" onclick="closeModal('importModal')">&times;</button>
      </div>
      <div class="modalBody">
        <p class="help">CSV s√∫bor mus√≠ obsahova≈• stƒ∫pce: meno, email, zdroj (voliteƒæn√©)</p>
        <input type="file" id="csvFileInput" accept=".csv" />
        <div id="csvPreview" style="display:none; margin-top:1rem;">
          <h4>N√°hƒæad (prv√Ωch 5 riadkov):</h4>
          <div class="tableWrapper">
            <table class="invoiceTable" id="csvPreviewTable"></table>
          </div>
        </div>
      </div>
      <div class="modalFooter">
        <button class="btn btn--ghost" onclick="closeModal('importModal')">Zru≈°i≈•</button>
        <button class="btn btn--primary" id="confirmImportBtn">Importova≈•</button>
      </div>
    </div>
  </div>

  <!-- Email Preview Modal -->
  <div id="previewModal" class="modal" style="display:none;">
    <div class="modalContent modalLarge">
      <div class="modalHeader">
        <h3>N√°hƒæad emailu</h3>
        <button class="modalClose" onclick="closeModal('previewModal')">&times;</button>
      </div>
      <div class="modalBody">
        <div class="emailPreview" id="emailPreviewContent">
          <div class="emailPreviewHeader">
            <strong>Od:</strong> FerkoMedia &lt;noreply@portretnefilmy.sk&gt;<br>
            <strong>Predmet:</strong> <span id="previewSubject"></span>
          </div>
          <div class="emailPreviewBody" id="previewBody"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Contact Notes Modal -->
  <div id="notesModal" class="modal" style="display:none;">
    <div class="modalContent">
      <div class="modalHeader">
        <h3>Pozn√°mky ku kontaktu</h3>
        <button class="modalClose" onclick="closeModal('notesModal')">&times;</button>
      </div>
      <div class="modalBody">
        <p><strong>Email:</strong> <span id="notesContactEmail"></span></p>
        <textarea id="contactNotes" rows="6" placeholder="Pridaj pozn√°mky..." style="width:100%; padding:0.75rem; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background:rgba(0,0,0,0.3); color:white;"></textarea>
        <div id="notesHistory" style="margin-top:1rem;">
          <h4>Hist√≥ria pozn√°mok:</h4>
          <div class="notesList"></div>
        </div>
      </div>
      <div class="modalFooter">
        <button class="btn btn--ghost" onclick="closeModal('notesModal')">Zru≈°i≈•</button>
        <button class="btn btn--primary" id="saveNotesBtn">Ulo≈æi≈•</button>
      </div>
    </div>
  </div>

  <!-- Add Tag Modal -->
  <div id="addTagModal" class="modal" style="display:none;">
    <div class="modalContent">
      <div class="modalHeader">
        <h3>Prida≈• tag</h3>
        <button class="modalClose" onclick="closeModal('addTagModal')">&times;</button>
      </div>
      <div class="modalBody">
        <select id="selectTagToAdd" style="width:100%; padding:0.75rem; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background:rgba(0,0,0,0.3); color:white;">
          <option value="VIP">VIP</option>
          <option value="Z√°ujemca">Z√°ujemca</option>
          <option value="K√∫pil">K√∫pil</option>
        </select>
      </div>
      <div class="modalFooter">
        <button class="btn btn--ghost" onclick="closeModal('addTagModal')">Zru≈°i≈•</button>
        <button class="btn btn--primary" id="confirmAddTagBtn">Prida≈•</button>
      </div>
    </div>
  </div>
<!-- Create Automation Modal -->
  <div id="createAutomationModal" class="modal" style="display:none;">
    <div class="modalContent">
      <div class="modalHeader">
        <h3>Vytvori≈• nov√∫ automatiz√°ciu</h3>
        <button class="modalClose" onclick="closeModal('createAutomationModal')">&times;</button>
      </div>
      <div class="modalBody">
        <form id="newAutomationForm">
          <div class="formGrid">
            <div class="field fieldFull">
              <label for="autoName">N√°zov automatiz√°cie</label>
              <input id="autoName" type="text" placeholder="Napr. Onboarding s√©ria" required />
            </div>

            <div class="field fieldFull">
              <label for="autoTrigger">Trigger</label>
              <select id="autoTrigger" required>
                <option value="">Vyber trigger</option>
                <option value="new-contact">Nov√Ω kontakt</option>
                <option value="workshop-complete">Po workshope</option>
                <option value="tag-added">Pri pridan√≠ tagu</option>
                <option value="inactivity">Po X d≈àoch neƒçinnosti</option>
              </select>
            </div>

            <div class="field" id="inactivityDaysField" style="display:none;">
              <label for="autoDays">Poƒçet dn√≠ neƒçinnosti</label>
              <input id="autoDays" type="number" value="30" min="1" />
            </div>

            <div class="field" id="tagTriggerField" style="display:none;">
              <label for="autoTriggerTag">Pri akom tagu?</label>
              <select id="autoTriggerTag">
                <option value="VIP">VIP</option>
                <option value="Z√°ujemca">Z√°ujemca</option>
                <option value="K√∫pil">K√∫pil</option>
              </select>
            </div>

            <div class="field fieldFull">
              <label for="autoEmailSubject">Predmet emailu</label>
              <input id="autoEmailSubject" type="text" placeholder="Ahoj {meno}, vitaj!" required />
            </div>

            <div class="field fieldFull">
              <label for="autoEmailContent">Obsah emailu (HTML)</label>
              <textarea id="autoEmailContent" rows="8" placeholder="<h1>Vitaj!</h1><p>Text...</p>" required></textarea>
            </div>
          </div>

          <div class="formActions">
            <button type="button" class="btn btn--ghost" onclick="closeModal('createAutomationModal')">Zru≈°i≈•</button>
            <button type="submit" class="btn btn--primary">Vytvori≈• automatiz√°ciu</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Automation Modal -->
  <div id="editAutomationModal" class="modal" style="display:none;">
    <div class="modalContent">
      <div class="modalHeader">
        <h3>Upravi≈• automatiz√°ciu</h3>
        <button class="modalClose" onclick="closeModal('editAutomationModal')">&times;</button>
      </div>
      <div class="modalBody">
        <form id="editAutomationForm">
          <input type="hidden" id="editAutoId" />

          <div class="formGrid">
            <div class="field fieldFull">
              <label for="editAutoName">N√°zov</label>
              <input id="editAutoName" type="text" required />
            </div>

            <div class="field fieldFull">
              <label for="editAutoSubject">Predmet emailu</label>
              <input id="editAutoSubject" type="text" required />
            </div>

            <div class="field fieldFull">
              <label for="editAutoContent">Obsah emailu (HTML)</label>
              <textarea id="editAutoContent" rows="10" required></textarea>
            </div>

            <div class="field fieldFull">
              <label>
                <input type="checkbox" id="editAutoActive" />
                Akt√≠vna automatiz√°cia
              </label>
            </div>
          </div>

          <div class="formActions">
            <button type="button" class="btn btn--ghost" onclick="closeModal('editAutomationModal')">Zru≈°i≈•</button>
            <button type="submit" class="btn btn--primary">Ulo≈æi≈• zmeny</button>
          </div>
        </form>
      </div>
    </div>
  </div>
<script>
document.addEventListener('DOMContentLoaded', () => {

  const adminPassword = "MyFilmy2026@";

  /* =====================
     TABS
  ===================== */
  document.querySelectorAll('.adminTab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.adminTab, .tabContent')
        .forEach(el => el.classList.remove('active'));

      tab.classList.add('active');
      document.getElementById(`tab-${tab.dataset.tab}`)?.classList.add('active');

      if (tab.dataset.tab === 'email') loadEmailStats();
    });
  });

  document.querySelectorAll('.subTab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.subTab, .subTabContent')
        .forEach(el => el.classList.remove('active'));

      tab.classList.add('active');
      document.getElementById(`subtab-${tab.dataset.subtab}`)?.classList.add('active');
    });
  });

  /* =====================
     WORKSHOP JSON
  ===================== */
  document.getElementById('addTermForm')?.addEventListener('submit', e => {
    e.preventDefault();
    const term = {
      title: title.value,
      date: date.value,
      city: city.value,
      price: +price.value,
      capacity: +capacity.value,
      status: status.value
    };
    jsonCode.textContent = JSON.stringify(term, null, 2);
    jsonOutput.style.display = 'block';
  });

  /* =====================
     INVOICES
  ===================== */
  let offset = 0;
  const limit = 50;
  let allInvoices = [];

  document.getElementById('loadInvoices')?.addEventListener('click', () => loadInvoices(false));
  document.getElementById('loadMore')?.addEventListener('click', () => {
    offset += limit;
    loadInvoices(true);
  });

  document.getElementById('searchInvoice')?.addEventListener('input', e =>
    filterInvoices(e.target.value.toLowerCase())
  );

  async function loadInvoices(append) {
    const key = prompt('Admin kƒæ√∫ƒç:');
    if (!key) return;

    const res = await fetch(`/api/get-invoices?key=${key}&limit=${limit}&offset=${offset}`);
    const data = await res.json();

    allInvoices = append ? [...allInvoices, ...data.invoices] : data.invoices;
    renderInvoices(allInvoices);
  }

  function renderInvoices(list) {
    const tbody = invoiceTableBody;
    tbody.innerHTML = list.length
      ? list.map(inv => `
        <tr>
          <td><strong>${inv.id}</strong></td>
          <td>${new Date(inv.createdAt).toLocaleDateString('sk-SK')}</td>
          <td>${inv.customerName}<div class="subtext">${inv.customerEmail}</div></td>
          <td>${inv.productName}</td>
          <td class="amount">${inv.amount} ‚Ç¨</td>
          <td><span class="badge badge--success">Uhraden√°</span></td>
        </tr>`).join('')
      : `<tr><td colspan="6" class="emptyState">≈Ωiadne fakt√∫ry</td></tr>`;
  }

  function filterInvoices(q) {
    renderInvoices(allInvoices.filter(i =>
      Object.values(i).some(v => String(v).toLowerCase().includes(q))
    ));
  }

  /* =====================
     EMAIL CONTACTS
  ===================== */
  let allContacts = [];
  let selectedContacts = [];

  async function loadEmailStats() {
    const res = await fetch('/api/contacts/stats', {
      headers: { Authorization: `Bearer ${adminPassword}` }
    });
    const d = await res.json();
    if (!d.ok) return;

    emailStatTotal.textContent = d.total;
    emailStatWorkshops.textContent = d.workshop;
    emailStatContact.textContent = d.kontakt;
    emailStatCampaigns.textContent = d.campaigns;
  }

  document.getElementById('loadContacts')?.addEventListener('click', async () => {
    const res = await fetch('/api/contacts/list', {
      headers: { Authorization: `Bearer ${adminPassword}` }
    });
    const d = await res.json();
    allContacts = d.contacts || [];
    renderContacts(allContacts);
    loadEmailStats();
  });

  function renderContacts(list) {
    contactsTableBody.innerHTML = list.map(c => `
      <tr>
        <td><input type="checkbox" value="${c.email}" class="contact-checkbox"></td>
        <td>${c.name || '-'}</td>
        <td>${c.email}</td>
        <td>${c.source}</td>
        <td>${new Date(c.createdAt).toLocaleDateString('sk-SK')}</td>
      </tr>
    `).join('');

    document.querySelectorAll('.contact-checkbox')
      .forEach(cb => cb.addEventListener('change', updateSelected));
  }

  function updateSelected() {
    selectedContacts = [...document.querySelectorAll('.contact-checkbox:checked')]
      .map(c => c.value);
  }

  /* =====================
     AUTOMATIONS
  ===================== */
  window.editAutomation = type => {
    const automations = {
      welcome: {
        name: 'Welcome',
        subject: 'Vitaj!',
        content: '<h1>Ahoj {meno}</h1>',
        active: true
      },
      followup: {
        name: 'Follow-up',
        subject: 'Ako sa ti p√°ƒçilo?',
        content: '<p>D√∫fame ≈æe super</p>',
        active: true
      }
    };

    const a = automations[type] || automations.welcome;

    editAutoId.value = type;
    editAutoName.value = a.name;
    editAutoSubject.value = a.subject;
    editAutoContent.value = a.content;
    editAutoActive.checked = a.active;

    openModal('editAutomationModal');
  };

  /* =====================
     MODALS
  ===================== */
  window.openModal = id => document.getElementById(id).style.display = 'flex';
  window.closeModal = id => document.getElementById(id).style.display = 'none';

  loadCampaignHistory();
});
</script>
